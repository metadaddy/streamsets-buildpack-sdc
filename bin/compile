#!/bin/bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# Fail fast
set -e

BP_DIR=$(cd $(dirname $0)/..; pwd) # absolute path
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

source /dev/stdin <<< "$(curl -s --retry 3 -L https://lang-common.s3.amazonaws.com/buildpack-stdlib/v4/stdlib.sh)"

export_env $ENV_DIR "." "JAVA_OPTS|JAVA_TOOL_OPTIONS"

echo "-----> Downloading and extracting JVM"
# download the buildpack
JVM_COMMON_BUILDPACK=${JVM_COMMON_BUILDPACK:-https://codon-buildpacks.s3.amazonaws.com/buildpacks/heroku/jvm-common.tgz}
mkdir -p /tmp/jvm-common
curl --silent --location $JVM_COMMON_BUILDPACK | tar xzm -C /tmp/jvm-common --strip-components=1
. /tmp/jvm-common/bin/util
. /tmp/jvm-common/bin/java

# install JDK
javaVersion=$(detect_java_version ${BUILD_DIR})
install_java ${BUILD_DIR} ${javaVersion}

# Install SDC, AWS, JDBC stage libs
echo "-----> Downloading and extracting StreamSets Data Collector ${SDC_VERSION}"
curl -s --retry 3 -L http://archives.streamsets.com/datacollector/${SDC_VERSION}/tarball/streamsets-datacollector-core-${SDC_VERSION}.tgz | tar xz -C ${BUILD_DIR}
echo "-----> Downloading and extracting StreamSets Data Collector AWS Stage Library ${SDC_VERSION}"
curl -s --retry 3 -L http://archives.streamsets.com/datacollector/${SDC_VERSION}/tarball/streamsets-datacollector-aws-lib-${SDC_VERSION}.tgz | tar xz -C ${BUILD_DIR}
echo "-----> Downloading and extracting StreamSets Data Collector JDBC Stage Library ${SDC_VERSION}"
curl -s --retry 3 -L http://archives.streamsets.com/datacollector/${SDC_VERSION}/tarball/streamsets-datacollector-jdbc-lib-${SDC_VERSION}.tgz | tar xz -C ${BUILD_DIR}

echo "-----> Downloading Postgres JDBC Driver"
mkdir -p ${BUILD_DIR}/streamsets-datacollector-${SDC_VERSION}/streamsets-libs-extras/streamsets-datacollector-jdbc-lib/lib
(cd ${BUILD_DIR}/streamsets-datacollector-${SDC_VERSION}/streamsets-libs-extras/streamsets-datacollector-jdbc-lib/lib; curl -s --retry 3 -L -O https://jdbc.postgresql.org/download/postgresql-42.1.4.jar)

# Change the SDC port number
sed -i '/^http.port=/c\http.port=${env(PORT)}' ${BUILD_DIR}/streamsets-datacollector-${SDC_VERSION}/etc/sdc.properties

# echo "-----> Downloading and extracting StreamSets Java SDK"
# curl -s -H "Authorization: token ${GITHUB_TOKEN}" -H 'Accept: application/vnd.github.v3.raw' -L https://api.github.com/repos/metadaddy/streamsets-java-sdk/contents/tbd.tgz | tar xz -C ${BUILD_DIR}

mvn --version

exit 0;